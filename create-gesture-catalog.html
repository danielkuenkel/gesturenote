<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" onclick="onCloseClick()">&times;</button>
    <h4 class="modal-title" id="exampleModalLabel">Gestenset zusammenstellen</h4>
</div>
<div id="modal-body" class="modal-body">

    <div class="panel panel-default hidden gesture-thumbnail root" id="gesture-thumbnail">
        <div class="panel-heading" style=" text-overflow:ellipsis; white-space:nowrap; overflow: hidden;">

            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-default btn-shadow gesture-assemble"><i class="glyphicon glyphicon-star"></i></button>
                <button type="button" class="btn btn-default btn-shadow gesture-details"><i class="glyphicon glyphicon-eye-open"></i></button>
            </div>
            <span class="title-text ellipsis" style="margin-left: 10px; position: relative; top: 2px;"></span>

            <div class="panel-title pull-right">
                <span class="label label-default" id="gesture-source" style="position: relative; top: -1px;"></span>
            </div>
            <div class="clearfix"></div>

        </div>

        <div class="panel-collapse collapse">
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="imageContainer previewGesture mouseScrollable"></div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-success" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="gesture-type"></div>
                        <div class="body-type"></div><br>
                        <div class="description"></div>
                        <div style="margin-top: 10px;">
                            <button type="button" class="btn btn-success btn-shadow gesture-assemble-description btn-block"><i class="glyphicon glyphicon-star"></i> Zum Set hinzufügen</button>
                            <button type="button" class="btn btn-danger btn-shadow gesture-unassemble-description btn-block hidden"><i class="glyphicon glyphicon-star-empty"></i> Vom Set entfernen</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="item-view">
        <div class="panel-group">
            <div class="form-group">
                <div class="input-group">
                    <span class="input-group-addon">Filter</span>
                    <input class="form-control item-input-text show-dropdown text-center readonly" tabindex="-1" type="text" value="Alle"/>
                    <div class="input-group-btn select" id="filterGestures" role="group">
                        <button class="btn btn-default btn-shadow btn-dropdown dropdown-toggle" type="button" data-toggle="dropdown" style="border-radius: 0px"><span class="chosen hidden" id="all"></span><span class="caret"></span></button>
                        <ul class="dropdown-menu option dropdown-menu-right" role="menu">
                            <li id="all" class="selected"><a href="#">Alle</a></li>
                            <li id="own"><a href="#">Eigene</a></li>
                            <li id="public"><a href="#">Öffentliche</a></li>
                        </ul>
                    </div>
                    <span class="input-group-addon">Sortierung</span>
                    <input class="form-control item-input-text show-dropdown text-center readonly" tabindex="-1" type="text" value="Bitte wählen"/>
                    <div class="input-group-btn select" id="sortGestures" role="group">
                        <button class="btn btn-default btn-shadow btn-dropdown dropdown-toggle" type="button" data-toggle="dropdown"><span class="chosen hidden" id="unselected"></span><span class="caret"></span></button>
                        <ul class="dropdown-menu option dropdown-menu-right" role="menu">
                            <li class="dropdown-header">Datum</li>
                            <li id="oldest"><a href="#">Älteste zuerst</a></li>
                            <li id="newest"><a href="#">Neueste zuerst</a></li>
                            <li class="divider"></li>
                            <li class="dropdown-header">Gestentitel</li>
                            <li id="asc"><a href="#">A bis Z</a></li>
                            <li id="desc"><a href="#">Z bis A</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <span class="input-group-addon">Suchen</span>
                    <input class="form-control item-input-text search" id="searched-input" autocomplete="off" type="search" value="" placeholder="Suchbegriff eingeben"/>
                    <span class="input-group-addon">Einträge pro Seite</span>
                    <input class="form-control item-input-text show-dropdown text-center readonly" tabindex="-1" type="text" value="10"/>
                    <div class="input-group-btn select" id="resultsCountSelect" role="group">
                        <button class="btn btn-default btn-shadow btn-dropdown dropdown-toggle" type="button" data-toggle="dropdown"><span class="chosen hidden" id="results_10"></span><span class="caret"></span></button>
                        <ul class="dropdown-menu option dropdown-menu-right" role="menu">
                            <li id="results_10" class="selected"><a href="#">10</a></li>
                            <li id="results_50"><a href="#">50</a></li>
                            <li id="results_100"><a href="#">100</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center custom-pagination" id="gesture-pager">
            <nav>
                <ul class="pagination pagination-custom" itemprop="clipping_2">
                    <li id="btn-first-page"><a href="#" aria-label="First"><i class="fa fa-angle-double-left" aria-hidden="true"></i></a></li>
                    <li id="btn-previous-page"><a href="#" aria-label="Previous"><i class="fa fa-angle-left" aria-hidden="true"></i></a></li>
                    <li id="btn-next-page"><a href="#" aria-label="Next"><i class="fa fa-angle-right" aria-hidden="true"></i></a></li>
                    <li id="btn-last-page"><a href="#" aria-label="Last"><i class="fa fa-angle-double-right" aria-hidden="true"></i></a></li>
                </ul>
            </nav>
        </div>


        <div class="panel-group container-root root" id="list-container"></div>

        <div class="alert-space alert-no-search-results"></div>
    </div>

</div>
<div id="modal-footer" class="modal-footer">
    <button type="button" class="btn btn-default btn-shadow" data-dismiss="modal" onclick="onCloseClick()"><span class="glyphicon glyphicon-floppy-disk"></span> Speichern & Schließen</button>
</div>


<script type="text/javascript" src="js/template-create.js"></script>
<script>
        currentGestureSet = null;

        function renderData(data) {
            currentData = data;
            initPagination($('#gesture-pager .pagination'), data.length, parseInt($('#resultsCountSelect .chosen').attr('id').split('_')[1]));
            updateView(0);
        }

        function updateView(index) {
            $('#list-container').empty();

            var listCount = parseInt($('#resultsCountSelect .chosen').attr('id').split('_')[1]);
            var viewFromIndex = index * listCount;
            var viewToIndex = Math.min((index + 1) * listCount, currentData.length);
            for (var i = viewFromIndex; i < viewToIndex; i++) {

                var clone = $('#gesture-thumbnail').clone();
                clone.removeClass('hidden');
                clone.attr('id', currentData[i].id);
                clone.find('.title-text').text(currentData[i].title + " ");
                clone.find('.description').text(currentData[i].description);
                clone.find('.gesture-type').text(translation.gestureType + ': ' + translation.gestureTypes[currentData[i].gestureType]);
                clone.find('.body-type').text(translation.bodyType + ': ' + translation.bodyTypes[currentData[i].bodyType]);
                clone.find('#gesture-source').text(translation.gestureSources[currentData[i].type]);
                $('#list-container').append(clone);

                if (isGestureAssembled(currentData[i].id)) {
                    clone.find('.gesture-assemble').click();
                }
            }
        }

        function saveData() {
            var currentGestures = $('#list-container').children();

            for (var j = 0; j < currentGestures.length; j++) {
                var gesture = currentGestures[j];
                var id = parseInt($(gesture).attr('id'));
                if ($(gesture).hasClass('selected') && !isGestureAssembled(id)) {
                    assembleGesture(id);
                } else if (!$(gesture).hasClass('selected') && isGestureAssembled(id)) {
                    reassembleGesture(id);
                }
            }
        }

        $('body').on('click', '.gesture-thumbnail, .gesture-details', function (event) {
            event.preventDefault();
            if (!event.handled) {
                event.handled = true;
                toggleCollapse($(this).closest('.root').find('.panel-collapse'));

                if ($(this).find('.panel-collapse').hasClass('in')) {
                    var gestureId = $(this).closest('.gesture-thumbnail').attr('id');
                    var gesture = getGestureById(gestureId);
                    renderGestureImages($(this).closest('.gesture-thumbnail').find('.imageContainer'), gesture.images, gesture.previewImage, function () {
                        console.log('images loaded');
                    });
                }
            }
        });

        function toggleCollapse(element) {
            if (!$(element).hasClass('in')) {
                var brothers = $(element).closest('.panel-group').children();
                for (var i = 0; i < brothers.length; i++) {
                    $(brothers[i]).find('.panel-collapse').removeClass('in');
                }
                $(element).addClass('in');
            } else {
                $(element).removeClass('in');
            }
        }

        $('body').on('click', '.gesture-assemble, .gesture-assemble-description, .gesture-unassemble-description', function (event) {
            event.preventDefault();
            if (!event.handled) {
                event.handled = true;
                var thumbnail = $(this).closest('.gesture-thumbnail');

                if (!$(this).closest('.gesture-thumbnail').hasClass('selected')) {
                    thumbnail.addClass('selected');
                    thumbnail.addClass('panel-success');
                    thumbnail.find('.gesture-assemble').addClass('btn-success');
                    thumbnail.find('.gesture-assemble-description').addClass('hidden');
                    thumbnail.find('.gesture-unassemble-description').removeClass('hidden');
                    thumbnail.find('#gesture-source').addClass('label-success');
                } else {
                    thumbnail.removeClass('selected');
                    thumbnail.removeClass('panel-success');
                    thumbnail.find('.gesture-assemble').removeClass('btn-success');
                    thumbnail.find('.gesture-assemble-description').removeClass('hidden');
                    thumbnail.find('.gesture-unassemble-description').addClass('hidden');
                    thumbnail.find('#gesture-source').removeClass('label-success');
                }
            }
        });

        $('#filterGestures .option li').unbind('change').bind('change', function (event) {
            event.preventDefault();

            saveData();
            renderData(sortGestures());

            if ($('#searched-input').val().trim() !== "") {
                $('#searched-input').trigger('keyup');
            }
        });

        $('#sortGestures .option li').unbind('change').bind('change', function (event) {
            event.preventDefault();

            saveData();
            renderData(sortGestures());

            if ($('#searched-input').val().trim() !== "") {
                $('#searched-input').trigger('keyup');
            }
        });

        $('#resultsCountSelect').unbind('change').bind('change', function (event) {
            event.preventDefault();

            saveData();
            renderData(currentData);

            if ($('#searched-input').val().trim() !== "") {
                $('#searched-input').trigger('keyup');
            }
        });

        function sortGestures() {
            var array = getFilteredGestures($('#filterGestures .chosen').attr('id'));
            var sortType = $('#sortGestures .chosen').attr('id');

            switch (sortType) {
                case SORT_ASC:
                    array = sortByKey(array, 'title', false);
                    break;
                case SORT_DESC:
                    array = sortByKey(array, 'title', true);
                    break;
                case SORT_NEWEST:
                    array = sortByKey(array, 'timestamp', true);
                    break;
                case SORT_OLDEST:
                    array = sortByKey(array, 'timestamp', false);
                    break;
            }
            return array;
        }


        function searchThroughGestures(gestures, filter) {
            var array = new Array();
            for (var i = 0; i < gestures.length; i++) {
                if (gestures[i].title.search(new RegExp(filter, "i")) > -1) {
                    array.push(gestures[i]);
                }
            }
            return array;
        }

        $('body').on('keyup', '.search', function (event) {
            event.preventDefault();
            if (!event.handled) {
                event.handled = true;
                saveData();
                var filter = $(this).val();
                var container = $('#list-container');
                container.removeClass('hidden');

                if (filter.trim() !== "" && event.keyCode !== 27) {
                    var matchedGestures = searchThroughGestures(sortGestures(), filter.trim());
                    if (matchedGestures.length > 0) {
                        showPanelBadges($(this).closest('.root').find('.badges'));
                        removeAlert($('#item-view'), ALERT_NO_SEARCH_RESULTS);
                        renderData(matchedGestures, true);
                    } else {
                        hidePanelBadges($(this).closest('.root').find('.badges'));
                        container.addClass('hidden');
                        appendAlert($('#item-view'), ALERT_NO_SEARCH_RESULTS);
                    }
                } else {
                    removeAlert($('#item-view'), ALERT_NO_SEARCH_RESULTS);
                    renderData(sortGestures());

                    if (event.keyCode === 27) {
                        resetInput($(this));
                    }
                }
            }
        });

        function resetInput(inputField) {
            $(inputField).val('');
        }

        function getFilteredGestures(gestureSource) {
            var array = new Array();
            if (!gestureSource) {
                gestureSource = $('#filterGestures').find('.chosen').attr('id');
            }


            var allGestures = getLocalItem(PREDEFINED_GESTURE_SET);

            if (gestureSource === 'all') {
                return allGestures;
            } else {
                for (var i = 0; i < allGestures.length; i++) {

                    if (allGestures[i].type === gestureSource) {
                        array.push(allGestures[i]);
                    }
                }
            }
            return array;
        }

        $(document).ready(function () {
            var data = getLocalItem(PREDEFINED_GESTURE_SET);

            if (data) {
                currentModalId = '#custom-modal';
                $('#sortGestures #newest').click();
            }
        });

        var recording = false;
        $('#btn-start-abort-recording').on('click', function (event) {
            event.preventDefault();
            if (!event.handled) {
                event.handled = true;

                if (recording) {
                    recording = false;
                    $(this).find('.btn-text').text('Neue Geste aufzeichnen');
                    $(this).removeClass('btn-danger').addClass('btn-success');
                    $('#recordGesture #list-container').removeClass('hidden');
                } else {
                    recording = true;
                    $(this).find('.btn-text').text('Aufzeichnung abbrechen');
                    $(this).removeClass('btn-success').addClass('btn-danger');
                    $('#recordGesture #list-container').addClass('hidden');
                }
            }
        });

        $('body').on('indexChanged', '.pagination', function (event, index) {
            event.preventDefault();
            if (!event.handled) {
                event.handled = true;
                saveData();
                updateView(index);
            }
        });
</script>