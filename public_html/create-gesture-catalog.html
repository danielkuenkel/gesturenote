<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" onclick="onCloseClick()">&times;</button>
    <h4 class="modal-title" id="exampleModalLabel">Gestenset zusammenstellen</h4>
</div>
<div id="modal-body" class="modal-body">

    <div class="panel panel-default hidden gesture-thumbnail root" id="gesture-thumbnail">
        <div class="panel-heading">
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-default btn-shadow gesture-assemble"><i class="glyphicon glyphicon-star"></i></button>
                <button type="button" class="btn btn-default btn-shadow gesture-details"><i class="glyphicon glyphicon-eye-open"></i></button>
            </div>

            <span class="title-text ellipsis" style="margin-left: 10px; position: relative; top: 2px;"></span>
        </div>
        <div class="panel-collapse collapse">
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="imageContainer previewGesture mouseScrollable"></div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-success" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="gesture-type"></div>
                        <div class="body-type"></div><br>
                        <div class="description"></div>
                        <div style="margin-top: 10px;">
                            <button type="button" class="btn btn-success btn-shadow gesture-assemble-description btn-block"><i class="glyphicon glyphicon-star"></i> Zum Set hinzufügen</button>
                            <button type="button" class="btn btn-danger btn-shadow gesture-unassemble-description btn-block hidden"><i class="glyphicon glyphicon-star-empty"></i> Vom Set entfernen</button>
                        </div>
                    </div>
                </div>
                <!--                <div class="thumbscrubber">
                                    <div class="preview hidden"></div>
                                    <div class="ts-inner"></div>
                                </div>
                                <div class="description-text" style="display: inline-block"></div>-->
            </div>
        </div>
    </div>

    <div>
        <div class="panel panel-default root" id="ownExtractedGestures">
            <div class="panel-heading clearfix">
                <div style="margin-top: 4px; display: inline-block">Extrahierte studienspezifische Gesten 
                    <div class="badges hidden" style="display: inline">
                        <div class="badge badgeId">0</div> von 
                        <div class="badge badgeQuantity">0</div> Gesten ausgewählt
                    </div>
                </div>
                <div class="btn-group pull-right" id="useGesturesSwitch">
                    <button class="btn btn-default switchButtonAddon">Nutzen?</button>
                    <button class="btn btn-default btn-shadow btn-toggle-checkbox btn-toggle-checkbox-panel inactive" id="yes" name="btn-success">Ja</button>
                    <button class="btn btn-warning btn-shadow btn-toggle-checkbox btn-toggle-checkbox-panel active" id="no" name="btn-warning">Nein</button>
                </div>
            </div>

            <div class="panel-body hidden">
                <div class="panel-group">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">Suchen</span>
                            <input class="form-control item-input-text search" id="filterOwnExtractedGestures" type="text" value="" placeholder="Suchbegriff eingeben"/>
                            <span class="input-group-addon">Sortierung</span>
                            <input class="form-control item-input-text option-phase show-dropdown text-center readonly" tabindex="-1" type="text" value="Bitte wählen"/>
                            <div class="input-group-btn select sortGestures" id="sortOwnExtractedGestures" role="group">
                                <button class="btn btn-default btn-shadow btn-dropdown dropdown-toggle" type="button" data-toggle="dropdown"><span class="selected hidden" id="unselected"></span><span class="caret"></span></button>
                                <ul class="dropdown-menu option dropdown-menu-right" role="menu">
                                    <li class="dropdown-header">Datum</li>
                                    <li id="oldest"><a href="#">Älteste zuerst</a></li>
                                    <li id="newest"><a href="#">Neueste zuerst</a></li>
                                    <li class="divider"></li>
                                    <li class="dropdown-header">Gestentitel</li>
                                    <li id="asc"><a href="#">A bis Z</a></li>
                                    <li id="desc"><a href="#">Z bis A</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-group root" id="list-container"></div>

                <div class="alert-space alert-no-search-results"></div>
            </div>
        </div>

        <div class="panel panel-default root" id="gestureCatalog">
            <div class="panel-heading clearfix">
                <div style="margin-top: 4px; display: inline-block">Gesten aus öffentlichem Gestenkatalog
                    <div class="badges hidden" style="display: inline">
                        <div class="badge badgeId">0</div> von 
                        <div class="badge badgeQuantity">0</div> Gesten ausgewählt
                    </div>
                </div>
                <div class="btn-group pull-right" id="useGesturesSwitch">
                    <button class="btn btn-default switchButtonAddon">Nutzen?</button>
                    <button class="btn btn-default btn-shadow btn-toggle-checkbox btn-toggle-checkbox-panel inactive" id="yes" name="btn-success">Ja</button>
                    <button class="btn btn-warning btn-shadow btn-toggle-checkbox btn-toggle-checkbox-panel active" id="no" name="btn-warning">Nein</button>
                </div>
            </div>
            <div class="panel-body hidden">

                <div class="panel-group">
                    <div class="form-group">
                        <div class="input-group">
                            <input class="form-control item-input-text search" id="filterCatalogGestures" type="text" value="" placeholder="Suchbegriff eingeben"/>
                            <span class="input-group-addon">Sortierung</span>
                            <input class="form-control item-input-text option-phase show-dropdown text-center readonly" tabindex="-1" type="text" value="Bitte wählen"/>
                            <div class="input-group-btn select sortGestures" id="sortCatalogGestures" role="group">
                                <button class="btn btn-default btn-shadow btn-dropdown dropdown-toggle" type="button" data-toggle="dropdown"><span class="selected hidden" id="unselected"></span><span class="caret"></span></button>
                                <ul class="dropdown-menu option dropdown-menu-right" role="menu">
                                    <li class="dropdown-header">Datum</li>
                                    <li id="oldest"><a href="#">Älteste zuerst</a></li>
                                    <li id="newest"><a href="#">Neueste zuerst</a></li>
                                    <li class="divider"></li>
                                    <li class="dropdown-header">Gestentitel</li>
                                    <li id="asc"><a href="#">A bis Z</a></li>
                                    <li id="desc"><a href="#">Z bis A</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-group root" id="list-container"></div>

                <div class="alert-space alert-no-search-results"></div>
            </div>
        </div>

        <div class="panel panel-default root" id="recordGesture">
            <div class="panel-heading clearfix">
                <div style="margin-top: 4px; display: inline-block">Neue Geste aufzeichnen</div>
                <div class="btn-group pull-right" id="useGesturesSwitch">
                    <button class="btn btn-default switchButtonAddon">Nutzen?</button>
                    <button class="btn btn-default btn-shadow btn-toggle-checkbox btn-toggle-checkbox-panel inactive" id="yes" name="btn-success">Ja</button>
                    <button class="btn btn-warning btn-shadow btn-toggle-checkbox btn-toggle-checkbox-panel active" id="no" name="btn-warning">Nein</button>
                </div>
            </div>
            <div class="panel-body hidden">
                <div class="panel-group root" id="list-container"></div>
            </div>
        </div>

    </div>


</div>
<div id="modal-footer" class="modal-footer">
    <button type="button" class="btn btn-default btn-shadow" data-dismiss="modal" onclick="onCloseClick()"><span class="glyphicon glyphicon-floppy-disk"></span> Speichern & Schließen</button>
</div>


<script type="text/javascript" src="js/template-create.js"></script>
<script>
        currentGestureSet = null;

        function renderData(data, isFilterData) {
            var ownExtractedGestures = 0;
            var gesetureCatalog = 0;

            if (!isFilterData) {
//                currentGestureSet = data;
//                console.log(data);
                for (var i = 0; i < data.length; i++) {

                    var clone = $('#gesture-thumbnail').clone();
                    clone.removeClass('hidden');
                    clone.attr('id', data[i].type + '.' + data[i].id);
                    clone.find('.title-text').text(data[i].title + " ");
                    clone.find('.description').text(data[i].description);
//                    clone.find('.preview').text(data[i].previewImage);
//                    clone.find('gesture-type').text();
                    clone.find('.gesture-type').text(translation.gestureType + ': ' + translation.gestureTypes[data[i].gestureType]);
                    clone.find('.body-type').text(translation.bodyType + ': ' + translation.bodyTypes[data[i].bodyType]);

                    switch (data[i].type) {
                        case GESTURE_OWN_PROJECT:
                            if (i === 0) {
                                $('#ownExtractedGestures #list-container').empty();
                            }

                            $('#ownExtractedGestures #list-container').append(clone);

                            if (ownExtractedGestures < 1 && data[i].used === true) {
                                ownExtractedGestures++;
                                $('#ownExtractedGestures #useGesturesSwitch #yes').click();
                            }

                            break;
                        case GESTURE_CATALOG:
                            if (i === 0) {
                                $('#gestureCatalog #list-container').empty();
                            }

                            $('#gestureCatalog #list-container').append(clone);

                            if (gesetureCatalog < 1 && data[i].used === true) {
                                gesetureCatalog++;
                                $('#gestureCatalog #useGesturesSwitch #yes').click();
                            }

                            break;
                    }

                    if (data[i].used === true) {
                        clone.find('.gesture-assemble').click();
                    }

                    renderGestureImages(clone.find('.imageContainer'), data[i].images, data[i].previewImage, function () {
                        console.log('images loaded');
                    });
                }
            } else {
                var gestures = data[0].type === GESTURE_OWN_PROJECT ? $('#ownExtractedGestures #list-container').children() : $('#gestureCatalog #list-container').children();
                for (var i = 0; i < gestures.length; i++) {
                    var gestureId = $(gestures[i]).attr('id').split('.')[1];
                    $(gestures[i]).addClass('hidden');
                    for (var j = 0; j < data.length; j++) {
                        if (parseInt(gestureId) === parseInt(data[j].id)) {
                            $(gestures[i]).removeClass('hidden');
                        }
                    }
                }
            }

            updatePanelBadges($('#ownExtractedGestures #list-container'));
            updatePanelBadges($('#gestureCatalog #list-container'));
        }

        function saveData() {
            var predefinedGestureSet = getLocalItem(PREDEFINED_GESTURE_SET);

            var selectedGestures = new Array();

            if ($('#ownExtractedGestures').find('#yes').hasClass('active')) {
                selectedGestures = $.merge(selectedGestures, $('#ownExtractedGestures #list-container').children('.selected'));
            }

            if ($('#gestureCatalog').find('#yes').hasClass('active')) {
                selectedGestures = $.merge(selectedGestures, $('#gestureCatalog #list-container').children('.selected'));
            }

            var assembledGestures = new Array();

            for (var i = 0; i < predefinedGestureSet.length; i++) {
                var isAssembled = false;
                var originItem = predefinedGestureSet[i];
                for (var j = 0; j < selectedGestures.length; j++) {
                    var gesture = selectedGestures[j];
                    var type = $(gesture).attr('id').split('.')[0];
                    var id = parseInt($(gesture).attr('id').split('.')[1]);
                    if (originItem.id === id && originItem.type === type) {
                        isAssembled = true;
                        break;
                    }
                }
                assembledGestures.push(new Gesture(originItem.type, originItem.id, originItem.timestamp, originItem.title, originItem.description, originItem.gestureType, originItem.bodyType, originItem.images, originItem.previewImage, originItem.videoUrl, isAssembled));
            }
            setLocalItem(PREDEFINED_GESTURE_SET, assembledGestures);
            currentGestureSet = assembledGestures;
        }

        function updatePanelBadges(container) {
            var max = $(container).children().not('.hidden').length;
            var selected = $(container).children('.selected').not('.hidden').length;

            $(container).parents().closest('.root').find('.badgeId').text(selected);
            $(container).parents().closest('.root').find('.badgeQuantity').text(max);
        }

        $('body').on('click', '.gesture-thumbnail, .gesture-details', function (event) {
            event.preventDefault();
            if (!event.handled) {
                event.handled = true;
                toggleCollapse($(this).closest('.root').find('.panel-collapse'));
            }
        });

        function toggleCollapse(element) {
            if (!$(element).hasClass('in')) {
                var brothers = $(element).closest('.panel-group').children();
                for (var i = 0; i < brothers.length; i++) {
                    $(brothers[i]).find('.panel-collapse').removeClass('in');
                }
                $(element).addClass('in');
            } else {
                $(element).removeClass('in');
            }
        }

        $('body').on('click', '.gesture-assemble, .gesture-assemble-description, .gesture-unassemble-description', function (event) {
            event.preventDefault();
            if (!event.handled) {
//                console.log('assemble clicked: ' + $(this).closest('.gesture-thumbnail').hasClass('selected'));
                event.handled = true;
                var thumbnail = $(this).closest('.gesture-thumbnail');

                if (!$(this).closest('.gesture-thumbnail').hasClass('selected')) {
                    thumbnail.addClass('selected');
                    thumbnail.addClass('panel-success');
                    thumbnail.find('.gesture-assemble').addClass('btn-success');
                    thumbnail.find('.gesture-assemble-description').addClass('hidden');
                    thumbnail.find('.gesture-unassemble-description').removeClass('hidden');
                } else {
                    thumbnail.removeClass('selected');
                    thumbnail.removeClass('panel-success');
                    thumbnail.find('.gesture-assemble').removeClass('btn-success');
                    thumbnail.find('.gesture-assemble-description').removeClass('hidden');
                    thumbnail.find('.gesture-unassemble-description').addClass('hidden');
                }

                updatePanelBadges($(this).closest('#list-container'));
            }
        });

        $('.sortGestures .option li').unbind('click').bind('click', function (event) {
            event.preventDefault();

            if ($(this).hasClass('dropdown-header') || $(this).hasClass('divider')) {
                return false;
            }
            console.log("sort choosed");
            saveData();
            var parentId = $(this).closest('.select').attr('id');
            var gestureType = parentId === 'sortOwnExtractedGestures' ? GESTURE_OWN_PROJECT : GESTURE_CATALOG;
            renderData(sortGestures(gestureType, $(this).attr('id')));

            if ($(this).closest('.input-group').find('.search').val().trim() !== "") {
                $(this).closest('.input-group').find('.search').trigger('keyup');
            }
        });

        function sortGestures(gestureType, sortType) {
            var array = getGesturesByType(gestureType);
            switch (sortType) {
                case SORT_ASC:
                    array = sortByKey(array, 'title', false);
//                    array.sort(sortBy('title', false));
                    break;
                case SORT_DESC:
                    array = sortByKey(array, 'title', true);
//                    array.sort(sortBy('title', true));
                    break;
                case SORT_NEWEST:
                    array = sortByKey(array, 'timestamp', true);
//                    array.sort(sortBy('timestamp', true));
                    break;
                case SORT_OLDEST:
                    array = sortByKey(array, 'timestamp', false);
//                    array.sort(sortBy('timestamp', false));
                    break;
            }
            return array;
        }

//        function sortBy(key, reverse) {
//
//            // Move smaller items towards the front
//            // or back of the array depending on if
//            // we want to sort the array in reverse
//            // order or not.
//            var moveSmaller = reverse ? 1 : -1;
//
//            // Move larger items towards the front
//            // or back of the array depending on if
//            // we want to sort the array in reverse
//            // order or not.
//            var moveLarger = reverse ? -1 : 1;
//
//            /**
//             * @param  {*} a
//             * @param  {*} b
//             * @return {Number}
//             */
//            return function (a, b) {
//                if (a[key] < b[key]) {
//                    return moveSmaller;
//                }
//                if (a[key] > b[key]) {
//                    return moveLarger;
//                }
//                return 0;
//            };
//        }

        function filterGestures(gestures, filter) {
            var array = new Array();
            for (var i = 0; i < gestures.length; i++) {
                if (gestures[i].title.search(new RegExp(filter, "i")) > -1) {
                    array.push(gestures[i]);
                }
            }
            return array;
        }

        $('body').on('keyup', '.search', function (event) {
            event.preventDefault();
            if (!event.handled) {
                event.handled = true;

                var gestureType = $(this).attr('id') === 'filterOwnExtractedGestures' ? GESTURE_OWN_PROJECT : GESTURE_CATALOG;
                var sortType = $(this).closest('.input-group').find('.select .selected').attr('id');
                var filter = $(this).val();
                var container = $(this).closest('.root').find('#list-container');
                container.removeClass('hidden');

                if (filter.trim() !== "" && event.keyCode !== 27) {
                    saveData();
                    var fGestures = filterGestures(sortGestures(gestureType, sortType), filter.trim());
                    if (fGestures.length > 0) {
                        showPanelBadges($(this).closest('.root').find('.badges'));
                        removeAlert($(this).closest('.root'), ALERT_NO_SEARCH_RESULTS);
                        renderData(fGestures, true);
                    } else {
                        hidePanelBadges($(this).closest('.root').find('.badges'));
                        container.addClass('hidden');
                        appendAlert($(this).closest('.root'), ALERT_NO_SEARCH_RESULTS);
                    }
                } else {
                    removeAlert($(this).closest('.root'), ALERT_NO_SEARCH_RESULTS);
                    renderData(sortGestures(gestureType, sortType));

                    if (event.keyCode === 27) {
                        resetInput($(this));
                        showPanelBadges($(this).closest('.root').find('.badges'));
                    }
                }
            }
        });

        function resetInput(inputField) {
            $(inputField).val('');
        }

        function getGesturesByType(type) {
//            var gestures = getLocalItem(PREDEFINED_GESTURE_SET);
            var array = new Array();
            for (var i = 0; i < currentGestureSet.length; i++) {
                if (currentGestureSet[i].type === type) {
                    array.push(currentGestureSet[i]);
                }
            }
            return array;
        }

        $(document).ready(function () {
            var data = getLocalItem(PREDEFINED_GESTURE_SET);
            if (data) {
                currentModalId = '#custom-modal';
                renderData(data);
                currentGestureSet = data;
                $('#ownExtractedGestures .sortGestures #newest').click();
                $('#gestureCatalog .sortGestures #newest').click();
            }
        });
</script>