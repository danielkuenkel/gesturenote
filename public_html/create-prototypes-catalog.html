<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" onclick="onCloseClick()">&times;</button>
    <h4 class="modal-title" id="exampleModalLabel">Prototypen</h4>
</div>
<div id="modal-body" class="modal-body">

    <div class="container-root" id="list-container"></div>

    <div class="form-group">
        <div class="btn-group btn-group-justified" role="group">

            <span class="input-group-addon" id="addFormatSelectAddon">Prototyp Format</span>

            <div class="btn-group select" id="addFormatSelect" role="group">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown"><span class="selected" id="unselected">Bitte wählen</span><span class="pull-right"><span class="caret"></span></span></button>
                <ul class="dropdown-menu option dropdown-menu-right" role="menu">
                    <li id="pidoco"><a href="#">Pidoco</a></li>
                    <li id="web"><a href="#">Webseite</a></li>
                    <li id="image"><a href="#">Bild</a></li>
                    <!--<li id="video"><a href="#">Video</a></li>-->
                    <li id="videoEmbed"><a href="#">Videoeinbettung</a></li>
                </ul>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-info toggable-button disabled" id="addFormat" type="button"><span class="glyphicon glyphicon-plus"></span></button>
            </div>
        </div>
    </div>

</div>
<div id="modal-footer" class="modal-footer">
    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="onCloseClick()"><span class="glyphicon glyphicon-floppy-disk"></span> Speichern & Schließen</button>
</div>


<script type="text/javascript" src="js/template-forms.js"></script>
<script>
        $(document).ready(function () {
            var data = getLocalItem(ASSEMBLED_PROTOTYPES);
            if (data !== null) {
                renderData(data);
            }

            $(window).resize(function () {
                console.log('window resized');
                var $allVideos = $("iframe[src*='www.youtube.com'], iframe[src*='player.vimeo.com']");
                // Resize all videos according to their own aspect ratio
                $allVideos.each(function () {
                    var video = $(this);
                    // Get parent width of this video
                    var newWidth = video.parent().width();
                    video.attr('width', newWidth);
                    video.attr('height', newWidth * video.data('aspectRatio'));
                });
            });

            setTimeout(function () {
                window.dispatchEvent(new Event('resize'));
            }, 100);
        });

        function renderData(data) {
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var clone = $('#form-item-container').find('#' + item.type).clone();
                clone.find('.title').val(item.title);
                $('#list-container').append(clone);
                updateBadges($('#list-container'), item.type);

                switch (item.type) {
                    case PROTOTYPE_PIDOCO:
                        if (item.options[0]) {
                            $(clone).find('.pidoco-edit-url').val(item.options[0]);
                            $(clone).find('.checkPidocoEditURL').click();
                        }
                        if (item.options[1]) {
                            $(clone).find('.pidoco-embed-url').val(item.options[1]);
                            $(clone).find('.checkPidocoEmbedURL').click();
                        }
                        break;
                    case PROTOTYPE_WEB:
                        $(clone).find('.website-url').val(item.options[0]);
                        break;
                    case PROTOTYPE_IMAGE:
                        if (item.data) {
                            $(clone).find('.imageAreaContent').attr("src", item.data);
                            $(clone).find('.imageArea').removeClass('hidden');
                            $(clone).find('.choosePrototypeImage .btn-text').text('Anderes Bild auswählen');
                            $(clone).find('.choosePrototypeImage .btn-icon').removeClass('glyphicon-picture');
                            $(clone).find('.choosePrototypeImage .btn-icon').addClass('glyphicon-refresh');
//                            control.replaceWith(control = control.clone(true));
                        }
                        break;
                    case PROTOTYPE_VIDEO_EMBED:
                        if (item.options[0]) {
                            $(clone).find('.video-embed-url').val(item.options[0]);
                            $(clone).find('.checkVideoEmbedURL').click();
                        }
                        break;
                }
            }

            checkCurrentListState($('#list-container'));
        }

        function saveData() {
            var assembledData = new Array();
            var items = $('#list-container').children();
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var type = $(item).attr('id');
                var title = $(item).find('.title').val();
                var options = new Array();
                var data = null;

                switch (type) {
                    case PROTOTYPE_PIDOCO:
                        var pidocoEditUrl = $(item).find('.pidoco-edit-url').val();
                        if (urlIsValid(pidocoEditUrl, TYPE_URL_PIDOCO_EDIT)) {
                            options.push(pidocoEditUrl);
                        } else {
                            options.push(null);
                        }
                        var pidocoEmbedUrl = $(item).find('.pidoco-embed-url').val();
                        if (urlIsValid(pidocoEmbedUrl, TYPE_URL_PIDOCO_EMBED)) {
                            options.push(pidocoEmbedUrl);
                        } else {
                            options.push(null);
                        }
                        break;
                    case PROTOTYPE_WEB:
                        options.push($(item).find('.website-url').val());
                        break;
                    case PROTOTYPE_IMAGE:
                        if ($(item).find('.imageArea').hasClass('hidden') !== true) {
                            data = $(item).find('.imageAreaContent').attr('src');
                        }
                        break;
                    case PROTOTYPE_VIDEO_EMBED:
                        var videoEmbedUrl = $(item).find('.video-embed-url').val();
                        if (urlIsValid(videoEmbedUrl, TYPE_URL_VIDEO_EMBED)) {
                            options.push(videoEmbedUrl);
                        } else {
                            options.push(null);
                        }
                        break;
                }

                if (options.length > 0 || data !== null) {
                    assembledData.push(new Prototype(type, title, options, data));
                }
            }
            setLocalItem(ASSEMBLED_PROTOTYPES, assembledData);
        }

        $('.transmit-gestures-select .checkAssembledGestures').on('click', function (event) {
            if ($(this).closest('.root').find('.transmit-gestures-select #success').hasClass('inactive')) {
                console.log('pidocoUseGestures');
                $(this).closest('.root').find('#transmitGestures').removeClass('hidden');
            }
        });

        $('body').on('click', '#transmitGestures', function (event) {
            if (event.handled !== true)
            {
                event.handled = true;
                console.log('transmit gestures clicked');
            }
        });
</script>